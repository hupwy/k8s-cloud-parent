## 终结和弱引用，软引用和幻像引用
一些应用程序通过使用终结处理和弱引用，软引用或幻像引用与垃圾回收进行交互。

这些功能可以在Java编程语言级别上创建性能工件。

这样的一个示例是依靠终结来关闭文件描述符，这使得外部资源（描述符）依赖于垃圾回收的及时性。

依靠垃圾回收来管理内存以外的资源几乎总是一个坏主意。

前言中的“ 相关文档”部分包含一篇文章，深入讨论了终结处理的一些陷阱以及避免这些陷阱的技术。

## 显式垃圾收集
应用程序可以与垃圾回收进行交互的另一种方式是通过调用显式调用完整的垃圾回收System.gc()。这可能会强制在没有必要时（例如，当次要收集就足够时）进行主要收集，因此通常应避免使用。可以通过使用标志禁用显式垃圾回收来评估显式垃圾回收的性能效果，该标志-XX:+DisableExplicitGC会使VM忽略对的调用System.gc()。

显式垃圾回收最常遇到的用途之一是远程方法调用（RMI）的分布式垃圾回收（DGC）。使用RMI的应用程序引用其他虚拟机中的对象。在不偶尔调用本地堆的垃圾收集的情况下，无法在这些分布式应用程序中收集垃圾，因此RMI会定期强制执行完整收集。可以使用属性控制这些收集的频率，如以下示例所示：

```shell
java -Dsun.rmi.dgc.client.gcInterval = 3600000
    -Dsun.rmi.dgc.server.gcInterval = 3600000 ...
```
本示例指定每小时一次的显式垃圾回收，而不是默认的每分钟一次的回收率。但是，这也可能导致某些对象需要更长的时间才能被回收。Long.MAX_VALUE如果不希望DGC活动的及时性有上限，可以将这些属性设置为高，以使显式收集之间的时间有效地无限。

## 软参考
在服务器虚拟机中，软引用的生存期比在客户端中更长。清除速率可以使用命令行选项控制，该选项-XX:SoftRefLRUPolicyMSPerMB=<N>指定对于堆中每兆字节的可用空间，软引用将保持活动状态的毫秒数（一旦不再严格可达）。缺省值为每兆字节1000毫秒，这意味着对于堆中的每兆字节可用空间，软引用（在收集到对对象的最后一个强引用之后）将保留1秒钟。这是一个大概的数字，因为仅在垃圾收集期间才清除软引用，这可能会偶尔发生。

## 类元数据
Java类在Java Hotspot VM中具有内部表示形式，称为类元数据。在Java Hotspot VM的先前版本中，类元数据是在所谓的永久生成中分配的。在JDK 8中，永久代已删除，并且类元数据已分配在本机内存中。默认情况下，可用于类元数据的本机内存量是无限的。使用该选项MaxMetaspaceSize对用于类元数据的本机内存量设置上限。

Java Hotspot VM显式管理用于元数据的空间。向操作系统请求空间，然后将其分成多个块。类加载器从其块分配元数据空间（块绑定到特定的类加载器）。当为类加载器卸载类时，其块将被回收以重新使用或返回给OS。元数据使用分配的空间mmap，而不是malloc。

如果UseCompressedOops打开并UseCompressedClassesPointers使用，则将本机内存的两个逻辑上不同的区域用于类元数据。与Java对象引用UseCompressedClassPointers一样UseCompressedOops，使用32位偏移量表示64位进程中的类指针。为这些压缩的类指针分配了一个区域（32位偏移量）。可以使用设置区域的大小，CompressedClassSpaceSize默认情况下为1 GB。压缩类指针的空间保留为mmap初始化时分配的空间，并根据需要提交。将MaxMetaspaceSize适用于犯下压缩类空间之和为其他类的元数据的空间。

卸载相应的Java类时，将重新分配类元数据。Java类是作为垃圾回收的结果而卸载的，并且可以引发垃圾回收以便卸载类和取消分配类元数据。当用于类元数据的空间达到一定级别（高水位线）时，将引发垃圾回收。垃圾收集之后，高水位线可能会升高或降低，具体取决于类元数据释放的空间量。高水位线将被抬高，以免过早引起另一次垃圾收集。高水位标记最初设置为命令行选项的值MetaspaceSize。根据选项MaxMetaspaceFreeRatio和MinMetaspaceFreeRatio。如果可用于类元数据的承诺空间占类元数据的总承诺空间的百分比大于MaxMetaspaceFreeRatio，则高水位线将降低。如果小于MinMetaspaceFreeRatio，则高水位线将升高。

为该选项指定一个较高的值，MetaspaceSize以避免早期为类元数据引发垃圾回收。为应用程序分配的类元数据的数量取决于应用程序，并且不存在用于选择的通用准则MetaspaceSize。默认大小MetaspaceSize取决于平台，范围从12 MB到大约20 MB。

有关用于元数据的空间的信息包含在堆的打印输出中。例11-1“典型堆打印输出”中显示了典型输出。

示例11-1典型的堆打印输出

堆
```shell
 PSYoungGen总计10752K，已用4419K
    [0xffffffff6ac00000、0xffffffff6b800000、0xffffffff6b800000）
    伊甸园空间9216K，已使用47％
      [0xffffffff6ac00000,0xffffffff6b050d68,0xffffffff6b500000）
    来自空间1536K，已使用0％
      [0xffffffff6b680000,0xffffffff6b680000,0xffffffff6b800000）
    到空间1536K，已使用0％
      [0xffffffff6b500000,0xffffffff6b500000,0xffffffff6b680000）
  ParOldGen总计20480K，使用了20011K
      [0xffffffff69800000、0xffffffff6ac00000、0xffffffff6ac00000）
    对象空间20480K，已使用97％ 
      [0xffffffff69800000,0xffffffff6ab8add8,0xffffffff6ac00000）
  使用的Metaspace为2425K，容量为4498K，已提交4864K，保留为1056768K
    类空间已用262K，容量386K，已提交512K，保留1048576K
```

在以开头的行中Metaspace，该used值是用于加载类的空间量。该capacity值是当前分配的块中可用于元数据的空间。该committed值是可用于块的空间量。该reserved值是为元数据保留（但不一定要提交）的空间量。以line开头的class space行包含压缩类指针的元数据的相应值