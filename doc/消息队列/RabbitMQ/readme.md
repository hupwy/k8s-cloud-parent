# RabbitMQ

## MQ入门

### 为什么用MQ

- 异步

	- 手机跨行转账

- 解耦

	- 一个功能需要多个服务处理，例如在线购票，由订单系统下单，配合库存系统，支付系统，通知系统分别进行扣减和通知处理才能完成这次完整业务，可以使用MQ将各个服务解耦（涉及分布式事务）

- 削峰

	- 防止服务瞬间流量峰值飙高，导致后端服务器崩溃，使用MQ将请求排队，保证服务器正常运行

- 广播

	- 一对多广播通信（不涉及分布式事务）

### 使用MQ带来的问题

- 复杂性提高，开发人员有多学习MQ知识并且应用
- 可用性降低，考虑到可靠性和延迟性，一旦网络出现问题会导致请求失败，严重影响业务
- 运维成本增加，多维护MQ服务

## 介绍

### 工作模型

- 核心对象

	- Broker

		- RabbitMQ服务器就叫做Broker

	- Conncetion

		- 生产者发送消息，消费者接收消息，需要跟Broker之间创建一个TCP的长连接

	- Channel

		- 多路复用，减少资源消耗
		- 虚拟连接，可以在保持TCP长连接里面去创建和释放Channel
		- 不同的Channel是相互隔离的，对于每个客户端线程来说Channel不共享
		- 定义交换机，队列，绑定关系，发送消息，校服消息都是调用Channel接口的方法

	- Queue

		- 存储消息对象，生产之和消费者的纽带，持久发到Mnesia数据库里

	- Consumer

		- Pull模式

			- 消费者中拉取队列中的消息，对应方法（basicGet）
			- 需要自己写定时任务拉取小时，实时性会降低，但是可以根基自己的消费能力决定拉取消息的频率

		- Push模式

			- 消息服务器推送给消费者，实时性很高，消费者能力不够会产生消息积压
			- Spring AMQP是用得push模式，通过时间机制对队列进行监听

		- 一条消息被消费者接口后，broker才会把消息从数据库中删除
		- 一个消费者可以监听多个队列，一个队列也可以被多个消费者监听，生产环境里推荐一个消费之只处理一个队列，想提高消费能力可以增多消费者

	- Exchange

		- 交换机，根据规则分发消息
		- 和每个接收消息的队列建立绑定关系，并为每个消息队列指定特殊的标识

	- Vhost

		- 可以根据不用的业务创建不同的虚拟机，使得提高硬件资源的利用率，并实现资源和权限的隔离
		- 不同的Vhost里可以有同名的Exchange和Queue
		- 默认Vhost是“/”

- 路由模型

	- 直连Direct

		- 规则

			- 队列与直连交换机绑定，需指定一个明确的绑定建（binding key）
			- 生产者发送消息时会写到一个路由键（routing key）
			- 消息的路由键与摸个队列的绑定建必须完全匹配

		- 直连类交换机适用于业务明确的消息

	- 广播Tipic

		- 规则

			- #代表0或多个单词
			- *代码不多不少一个单词
			- 例子：单词（word）指的是用英文的点“.”隔开的字符。a.bc.def是3个单词

		- 适用于根据业务主题或消息等级过滤消息的场景，例如：一条消息和资金有关，又跟风控有关，可以写两个单词一个管理资金系统，一个关联风控系统

	- 广播Fanout

		- 规则

			- 不需要绑定键，也不需要路由键
			- 例子：使用于一些通用的业务消息，例如：修改用户信息，向各级业务系统发送变更消息

	- headers（不常用，忽略）

### 高级特性

- 死信队列
- 延时队列
- 流量控制

## 入门

### 安装

- Docker安装RabbitMQ集群

- HAProxy+Keepalived搭建 RabbitMQ高可用集群

### 界面管理

## 使用

### RabbitMQ Java API

### Spring AMQP

- 生产者

	- 模板

- 消费者

	- 对象定义
	- 监听

## 可靠性于高可用

### 可靠性分析

- 服务端ACK
- 路由
- 队列存储
- 消费者ACK
- 回调
- 重发
- 幂等
- 最终一致性

### 高可用架构

- 集群节点

	- 磁盘节点
	- 内存节点

- 集群模式

	- 镜像队列
	- 普通集群

- HAProxy+KeepAlived
- Lvs

## 实践经验

### 资源管理

### 配置文件与命名规范

### 调用封装

### 信息落库+定时任务

### 生产环境运维监控

### 日志追踪

### 如何减少链接

*XMind - Trial Version*